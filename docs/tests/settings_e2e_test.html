<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>システム設定 E2Eテスト仕様書</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2980b9;
            margin-top: 30px;
        }
        h3 {
            color: #3498db;
            margin-top: 25px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        code {
            background-color: #f8f8f8;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Monaco, Consolas, 'Courier New', monospace;
            color: #e74c3c;
            font-size: 0.9em;
        }
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            line-height: 1.4;
        }
        .note {
            background-color: #ffffcc;
            padding: 10px 15px;
            border-left: 4px solid #ffcc00;
            margin: 15px 0;
        }
        .important {
            background-color: #ffe6e6;
            padding: 10px 15px;
            border-left: 4px solid #ff3333;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>システム設定 E2Eテスト仕様書</h1>
    
    <p>本ドキュメントでは、商品管理システムにおけるシステム設定機能のEnd-to-End（E2E）テスト仕様を定義します。</p>
    
    <h2>1. テスト概要</h2>
    
    <p>システム設定機能のE2Eテストでは、以下の機能が正常に動作することを確認します。</p>
    
    <ul>
        <li>設定ページへのアクセス制御（管理者権限確認）</li>
        <li>基本設定の表示と更新</li>
        <li>通知設定の表示と更新</li>
        <li>バックアップ設定の表示と更新</li>
        <li>タブ切り替え機能</li>
    </ul>
    
    <h2>2. テスト環境</h2>
    
    <h3>2.1 必要環境</h3>
    
    <ul>
        <li>Java 17以上</li>
        <li>Maven 3.6以上</li>
        <li>Docker および Docker Compose</li>
        <li>Playwright（自動的にダウンロードされます）</li>
    </ul>
    
    <h3>2.2 テスト実行方法</h3>
    
    <p>テストは以下のコマンドで実行できます：</p>
    
    <pre>
./run-e2e-tests.sh
</pre>
    
    <p>設定画面のテストのみを実行する場合：</p>
    
    <pre>
POSTGRES_HOST=localhost POSTGRES_PORT=5434 POSTGRES_DB=productmgr_test POSTGRES_USER=testuser POSTGRES_PASSWORD=testpass mvn -DskipClean=true test -Dtest=com.example.productmgr.e2e.playwright.SettingsPlaywrightTest
</pre>
    
    <div class="note">
        <p><strong>注意：</strong> テスト実行前にDockerが起動していることを確認してください。</p>
    </div>
    
    <h2>3. テストケース</h2>
    
    <h3>3.1 設定ページアクセステスト（testSettingsPageAccess）</h3>
    
    <table>
        <tr>
            <th width="20%">テスト項目</th>
            <td>設定ページへのアクセス確認</td>
        </tr>
        <tr>
            <th>前提条件</th>
            <td>管理者ユーザーでログイン済みであること</td>
        </tr>
        <tr>
            <th>テスト手順</th>
            <td>
                <ol>
                    <li>設定ページ（/settings）にアクセスする</li>
                    <li>ページのロードが完了するまで待機する</li>
                </ol>
            </td>
        </tr>
        <tr>
            <th>期待結果</th>
            <td>
                <ul>
                    <li>設定ページに正常にアクセスできること</li>
                    <li>設定フォームが表示されていること</li>
                </ul>
            </td>
        </tr>
        <tr>
            <th>自動化ポイント</th>
            <td>
                <ul>
                    <li>URLの確認: <code>assertTrue(page.url().contains("/settings"), "設定ページに正しく移動していること");</code></li>
                    <li>フォームの表示確認: <code>assertTrue(page.isVisible("form"), "設定フォームが表示されていること");</code></li>
                </ul>
            </td>
        </tr>
    </table>
    
    <h3>3.2 アクセス制御テスト（testSettingsAccessControl）</h3>
    
    <table>
        <tr>
            <th width="20%">テスト項目</th>
            <td>非管理者ユーザーのアクセス制御確認</td>
        </tr>
        <tr>
            <th>前提条件</th>
            <td>ログインしていない状態であること</td>
        </tr>
        <tr>
            <th>テスト手順</th>
            <td>
                <ol>
                    <li>ログインせずに設定ページ（/settings）に直接アクセスする</li>
                    <li>ページのロードが完了するまで待機する</li>
                </ol>
            </td>
        </tr>
        <tr>
            <th>期待結果</th>
            <td>
                <ul>
                    <li>ログインページにリダイレクトされること</li>
                </ul>
            </td>
        </tr>
        <tr>
            <th>自動化ポイント</th>
            <td>
                <ul>
                    <li>リダイレクト先の確認: <code>assertTrue(page.url().contains("/login"), "認証なしのアクセスは認証ページへリダイレクトされること");</code></li>
                </ul>
            </td>
        </tr>
    </table>
    
    <h3>3.3 基本設定更新テスト（testBasicSettingsUpdate）</h3>
    
    <table>
        <tr>
            <th width="20%">テスト項目</th>
            <td>基本設定の更新機能確認</td>
        </tr>
        <tr>
            <th>前提条件</th>
            <td>管理者ユーザーでログイン済みであること</td>
        </tr>
        <tr>
            <th>テスト手順</th>
            <td>
                <ol>
                    <li>設定ページ（/settings）にアクセスする</li>
                    <li>基本設定タブが表示されていることを確認する</li>
                    <li>会社名フィールドに新しい値を入力する</li>
                    <li>在庫少警告しきい値に新しい値を入力する</li>
                    <li>保存ボタンをクリックする</li>
                    <li>ページがリロードされるまで待機する</li>
                </ol>
            </td>
        </tr>
        <tr>
            <th>期待結果</th>
            <td>
                <ul>
                    <li>成功メッセージが表示されること</li>
                    <li>会社名フィールドに更新した値が表示されていること</li>
                    <li>在庫少警告しきい値フィールドに更新した値が表示されていること</li>
                </ul>
            </td>
        </tr>
        <tr>
            <th>自動化ポイント</th>
            <td>
                <ul>
                    <li>フォーム入力: <code>page.fill("#companyName", "テスト会社名" + System.currentTimeMillis() % 10000);</code></li>
                    <li>数値入力: <code>page.fill("#lowStockThreshold", "15");</code></li>
                    <li>保存ボタンクリック: <code>page.click("button[type=submit]");</code></li>
                    <li>成功メッセージ確認: <code>assertTrue(page.isVisible(".alert-success"), "成功メッセージが表示されること");</code></li>
                    <li>更新値の確認: <code>assertEquals("15", page.locator("#lowStockThreshold").inputValue(), "更新した値が保存されていること");</code></li>
                </ul>
            </td>
        </tr>
    </table>
    
    <h3>3.4 通知設定更新テスト（testNotificationSettingsUpdate）</h3>
    
    <table>
        <tr>
            <th width="20%">テスト項目</th>
            <td>通知設定の更新機能確認</td>
        </tr>
        <tr>
            <th>前提条件</th>
            <td>管理者ユーザーでログイン済みであること</td>
        </tr>
        <tr>
            <th>テスト手順</th>
            <td>
                <ol>
                    <li>設定ページ（/settings）にアクセスする</li>
                    <li>通知設定タブをクリックする</li>
                    <li>通知を有効にするチェックボックスを切り替える</li>
                    <li>通知メールアドレスに新しい値を入力する</li>
                    <li>保存ボタンをクリックする</li>
                    <li>ページがリロードされるまで待機する</li>
                </ol>
            </td>
        </tr>
        <tr>
            <th>期待結果</th>
            <td>
                <ul>
                    <li>成功メッセージが表示されること</li>
                    <li>通知タブを再度クリックすると、設定が更新されていること</li>
                </ul>
            </td>
        </tr>
        <tr>
            <th>自動化ポイント</th>
            <td>
                <ul>
                    <li>タブ切り替え: <code>page.click("#notification-tab");</code></li>
                    <li>チェックボックス操作: <code>page.click("#enableNotifications");</code></li>
                    <li>メールアドレス入力: <code>page.fill("#notificationEmail", "test" + System.currentTimeMillis() % 10000 + "@example.com");</code></li>
                    <li>保存後の確認: <code>page.click("#notification-tab"); assertTrue(page.isChecked("#enableNotifications"), "チェックボックスの状態が保存されていること");</code></li>
                </ul>
            </td>
        </tr>
    </table>
    
    <h3>3.5 バックアップ設定更新テスト（testBackupSettingsUpdate）</h3>
    
    <table>
        <tr>
            <th width="20%">テスト項目</th>
            <td>バックアップ設定の更新機能確認</td>
        </tr>
        <tr>
            <th>前提条件</th>
            <td>管理者ユーザーでログイン済みであること</td>
        </tr>
        <tr>
            <th>テスト手順</th>
            <td>
                <ol>
                    <li>設定ページ（/settings）にアクセスする</li>
                    <li>バックアップタブをクリックする</li>
                    <li>自動バックアップを有効にするチェックボックスを切り替える</li>
                    <li>バックアップ間隔に新しい値を入力する</li>
                    <li>保存ボタンをクリックする</li>
                    <li>ページがリロードされるまで待機する</li>
                </ol>
            </td>
        </tr>
        <tr>
            <th>期待結果</th>
            <td>
                <ul>
                    <li>成功メッセージが表示されること</li>
                    <li>バックアップタブを再度クリックすると、設定が更新されていること</li>
                </ul>
            </td>
        </tr>
        <tr>
            <th>自動化ポイント</th>
            <td>
                <ul>
                    <li>タブ切り替え: <code>page.click("#backup-tab");</code></li>
                    <li>チェックボックス操作: <code>page.click("#autoBackup");</code></li>
                    <li>バックアップ間隔入力: <code>page.fill("#backupIntervalDays", "14");</code></li>
                    <li>保存後の確認: <code>page.click("#backup-tab"); assertEquals("14", page.locator("#backupIntervalDays").inputValue(), "バックアップ間隔が正しく保存されていること");</code></li>
                </ul>
            </td>
        </tr>
    </table>
    
    <h3>3.6 タブ切り替えテスト（testTabSwitching）</h3>
    
    <table>
        <tr>
            <th width="20%">テスト項目</th>
            <td>設定タブ切り替え機能確認</td>
        </tr>
        <tr>
            <th>前提条件</th>
            <td>管理者ユーザーでログイン済みであること</td>
        </tr>
        <tr>
            <th>テスト手順</th>
            <td>
                <ol>
                    <li>設定ページ（/settings）にアクセスする</li>
                    <li>通知設定タブをクリックする</li>
                    <li>通知設定フォームが表示されるまで待機する</li>
                    <li>バックアップタブをクリックする</li>
                    <li>バックアップ設定フォームが表示されるまで待機する</li>
                    <li>基本設定タブをクリックする</li>
                    <li>基本設定フォームが表示されるまで待機する</li>
                </ol>
            </td>
        </tr>
        <tr>
            <th>期待結果</th>
            <td>
                <ul>
                    <li>各タブクリック後に対応するフォームが表示されること</li>
                    <li>アクティブなタブが視覚的に区別されること</li>
                </ul>
            </td>
        </tr>
        <tr>
            <th>自動化ポイント</th>
            <td>
                <ul>
                    <li>通知タブ切り替え: <code>page.click("#notification-tab");</code></li>
                    <li>タブコンテンツ表示確認: <code>assertTrue(page.isVisible("#notification form"), "通知設定フォームが表示されること");</code></li>
                    <li>タブのアクティブ状態確認: <code>assertTrue(page.locator("#notification-tab").hasClass("active"), "通知タブがアクティブ状態であること");</code></li>
                </ul>
            </td>
        </tr>
    </table>
    
    <h2>4. テストデータ設計</h2>
    
    <p>各テストは独立して実行できるよう、テストデータを動的に生成します。</p>
    
    <h3>4.1 テストデータ生成方法</h3>
    
    <pre>
// システム時刻を使った一意の値の生成
String uniqueCompanyName = "テスト会社" + System.currentTimeMillis() % 10000;
String uniqueEmail = "test" + System.currentTimeMillis() % 10000 + "@example.com";

// 設定値の更新
page.fill("#companyName", uniqueCompanyName);
page.fill("#notificationEmail", uniqueEmail);
</pre>
    
    <h2>5. テスト実装サンプル</h2>
    
    <p>以下は設定更新テストの実装サンプルです。</p>
    
    <pre>
@Test
public void testBasicSettingsUpdate() {
    // 管理者としてログイン
    login();
    
    // 設定ページに移動
    page.navigate(baseUrl + "/settings");
    page.waitForLoadState();
    
    // ページが正しく読み込まれていることを確認
    assertTrue(page.url().contains("/settings"), "設定ページに正しく移動していること");
    
    // 一意の会社名を生成
    String uniqueCompanyName = "テスト会社" + System.currentTimeMillis() % 10000;
    
    // フォームに値を入力
    page.fill("#companyName", uniqueCompanyName);
    page.fill("#lowStockThreshold", "15");
    
    // 保存ボタンをクリック
    page.click("button[type=submit]");
    
    // 成功メッセージを待機
    page.waitForSelector(".alert-success");
    
    // 値が保存されていることを確認
    assertEquals(uniqueCompanyName, page.inputValue("#companyName"));
    assertEquals("15", page.inputValue("#lowStockThreshold"));
}
</pre>
    
    <h2>6. テスト実行結果</h2>
    
    <p>テスト結果は <code>target/surefire-reports/</code> ディレクトリに出力されます。</p>
    
    <div class="important">
        <p><strong>注意事項：</strong></p>
        <ul>
            <li>設定更新テストは実際のシステム設定を変更するため、テスト環境でのみ実行してください。</li>
            <li>設定変更後のシステム動作確認も考慮すると良いでしょう。</li>
            <li>セッション管理やCSRF対策が正しく機能しているか確認するため、複数ブラウザでの同時操作テストも検討してください。</li>
        </ul>
    </div>
    
    <h2>7. トラブルシューティング</h2>
    
    <h3>7.1 よくある問題と解決策</h3>
    
    <table>
        <tr>
            <th>問題</th>
            <th>考えられる原因</th>
            <th>解決策</th>
        </tr>
        <tr>
            <td>管理者アクセスが必要なテストの失敗</td>
            <td>テストユーザーに管理者権限がない</td>
            <td>ログイン前にテストユーザーが管理者であることを確認する</td>
        </tr>
        <tr>
            <td>設定の保存後にリダイレクトされない</td>
            <td>フォーム送信の失敗またはバリデーションエラー</td>
            <td>フォーム入力値を確認し、エラーメッセージを検証する</td>
        </tr>
        <tr>
            <td>タブ切り替えが機能しない</td>
            <td>JavaScriptの実行エラーまたはCSSセレクタの不一致</td>
            <td>ページのJavaScriptエラーを確認し、正しいセレクタを使用する</td>
        </tr>
    </table>
    
    <h3>7.2 デバッグ方法</h3>
    
    <p>設定画面テストのデバッグには以下のアプローチが有効です：</p>
    
    <ul>
        <li>コンソール出力を活用する</li>
        <li>スクリーンショットを取得する</li>
        <li>タイムアウト値を調整する</li>
    </ul>
    
    <pre>
// デバッグ情報の出力例
System.out.println("Current form values - Company Name: " + page.inputValue("#companyName"));
System.out.println("Active tab: " + page.locator(".list-group-item.active").textContent());

// スクリーンショットの取得
page.screenshot(new Page.ScreenshotOptions().setPath(Paths.get("settings-debug.png")));
</pre>
</body>
</html>