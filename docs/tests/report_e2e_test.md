# レポート機能 E2Eテスト仕様書

本ドキュメントでは、商品管理システムにおけるレポート機能のEnd-to-End（E2E）テスト仕様を定義します。

> **注意：** レポート機能のテストでは、レポートの表示だけでなく、認証状態に応じたアクセス制御も重要なテスト対象です。

## 1. テスト概要

レポート機能のE2Eテストでは、以下の機能が正常に動作することを確認します。

- レポートページへのアクセス制御
- 各種レポートページの表示・動作
- レポートデータの表示・エクスポート機能

## 2. テスト環境

### 2.1 前提条件

- Java 17以上
- Maven 3.6以上
- Docker および Docker Compose
- Playwright（自動的にダウンロードされます）

### 2.2 テストデータ

テスト実行時には以下のデータが自動的に作成されています：

- 商品データ（複数のカテゴリを含む）
- 在庫履歴データ（入出庫履歴）
- 認証用ユーザーアカウント

### 2.3 テスト実行方法

全テストを実行する場合：

```bash
./run-e2e-tests.sh
```

レポート機能のテストのみを実行する場合：

```bash
./run-single-e2e-test.sh ReportPlaywrightTest
```

特定のテストメソッドのみを実行する場合：

```bash
./run-single-e2e-test.sh ReportPlaywrightTest#testReportAccess
```

## 3. テストケース

### 3.1 レポートアクセス制御テスト（testReportAccess）

| テスト項目 | レポートページへのアクセス制御確認 |
|------------|-----------------------------------|
| 前提条件 | テスト用アカウントが使用可能であること |
| テスト手順 | 1. 管理者ユーザーでログインする<br>2. レポートダッシュボード（/reports）に移動する<br>3. ページが正しく表示されることを確認する<br>4. ログアウトする<br>5. 未ログイン状態でレポートダッシュボードにアクセスを試みる |
| 期待結果 | - ログイン状態ではレポートページが正常に表示される<br>- 未ログイン状態ではログインページにリダイレクトされる |
| 自動化ポイント | - URL確認: `assertTrue(page.url().contains("/reports"), "レポートページに正しく移動していること");`<br>- コンテンツ確認: `assertTrue(page.isVisible("div.container"), "コンテナが表示されていること");`<br>- リダイレクト確認: `assertTrue(page.url().contains("/login"), "認証なしのアクセスは認証ページへリダイレクトされること");` |

### 3.2 各種レポートページアクセステスト（testAllReportPagesAccess）

| テスト項目 | 各レポートページへのアクセス確認 |
|------------|--------------------------------|
| 前提条件 | ユーザーがログイン済みであること |
| テスト手順 | 1. 管理者ユーザーでログインする<br>2. 以下のレポートページにそれぞれアクセスする:<br>   - 在庫警告レポート（/reports/stock-warning）<br>   - 在庫サマリーレポート（/reports/inventory-summary）<br>   - カテゴリ分布レポート（/reports/category-distribution）<br>   - 在庫回転率レポート（/reports/inventory-turnover）<br>   - 日次レポート（/reports/daily）<br>   - 月次レポート（/reports/monthly）<br>3. 各ページが正しく表示されることを確認する |
| 期待結果 | - 各レポートページに正常にアクセスでき、リダイレクトが発生しないこと<br>- ページ内容が正しく表示されること |
| 自動化ポイント | - 各ページへの順次アクセス: `for (String path : reportPaths) { page.navigate(baseUrl + path); }`<br>- URL確認: `assertTrue(page.url().contains(path), path + "ページに正しく移動していること");`<br>- リダイレクト非発生確認: `assertFalse(page.url().contains("/login"), "ログインページにリダイレクトされていないこと");` |

## 4. テスト実装

以下は、レポート機能のE2Eテスト実装例です：

```java
public class ReportPlaywrightTest extends BasePlaywrightTest {

    @Test
    public void testReportAccess() {
        // ログイン
        login();
        
        // レポートダッシュボードに移動
        page.navigate(baseUrl + "/reports");
        page.waitForLoadState();
        
        // URLが正しいことを確認
        assertTrue(page.url().contains("/reports"), "レポートページに正しく移動していること");
        
        // ログアウト
        logout();
        
        // コンテキストを閉じて新しいコンテキストとページを作成（完全にセッションをクリア）
        context.close();
        context = browser.newContext();
        page = context.newPage();
        
        // 認証なしでアクセスすると、ログインページにリダイレクトされることを確認
        page.navigate(baseUrl + "/reports");
        page.waitForLoadState();
        
        // リダイレクト先がログイン画面であることを確認
        assertTrue(page.url().contains("/login"), "認証なしのアクセスは認証ページへリダイレクトされること");
    }
    
    @Test
    public void testAllReportPagesAccess() {
        // ログイン
        login();
        
        // 各レポートページに移動し、アクセスできることを確認
        String[] reportPaths = {
            "/reports/stock-warning",
            "/reports/inventory-summary",
            "/reports/category-distribution",
            "/reports/inventory-turnover",
            "/reports/daily",
            "/reports/monthly"
        };
        
        for (String path : reportPaths) {
            // ページに移動
            page.navigate(baseUrl + path);
            page.waitForLoadState();
            
            // URLが正しいことを確認
            assertTrue(page.url().contains(path), path + "ページに正しく移動していること");
            
            // HTTPステータスコードが200であることを確認（リダイレクトされていないこと）
            assertFalse(page.url().contains("/login"), "ログインページにリダイレクトされていないこと");
        }
    }
}
```

## 5. フロー図

### レポートアクセステストのフロー

```
+-------------------+    +------------------------+    +----------------------+
| ログイン           | -> | レポートページアクセス   | -> | ページ表示確認        |
+-------------------+    +------------------------+    +----------------------+
                                                                |
                                                                v
+-------------------+    +------------------------+    +----------------------+
| ログインページ確認   | <- | 未認証アクセス          | <- | ログアウト           |
+-------------------+    +------------------------+    +----------------------+
```

## 6. 注意事項

> **テスト実行時の注意点：**
> - レポートテストは、データベースに十分なテストデータがあることを前提としています。データが不足している場合、一部のレポートが正しく表示されない可能性があります。
> - 特に日付範囲を指定するレポート（日次・月次レポート）では、期間内のデータ有無によってテスト結果が異なる場合があります。
> - レポートのCSVエクスポート機能をテストする場合は、ダウンロードの監視と検証が必要です。
> - テスト環境では、実際の本番データとは異なるサンプルデータを使用するため、レポートの内容自体の検証は基本的な表示確認にとどめています。

## 7. トラブルシューティング

### 7.1 よくある問題と解決策

| 問題 | 考えられる原因 | 解決策 |
|------|---------------|--------|
| レポートページのロードタイムアウト | データ集計に時間がかかっている | タイムアウト値を増やす: `page.setDefaultTimeout(90000);` |
| レポート要素が見つからない | レポート画面のレイアウトが変更された | 最新のHTML構造を確認し、セレクタを更新する |
| CSVエクスポートのダウンロードが検出されない | ダウンロード処理に時間がかかっている | ダウンロード待機時間を増やす: `page.waitForTimeout(10000);` |

## 8. まとめ

レポート機能のE2Eテストでは、各種レポートページへのアクセスと表示を確認することで、レポーティング機能全体の動作を検証しています。特に認証状態に応じたアクセス制御の検証は、システムのセキュリティ確保において重要です。

また、将来的な拡張として、レポートデータの内容検証やエクスポート機能の詳細なテストを追加することが検討されています。

[テスト仕様書目次に戻る](index.md)